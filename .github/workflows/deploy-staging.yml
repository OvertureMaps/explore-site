---
# This workflow will do a clean install of node dependencies and deploy to AWS.

name: Staging Deploy
run-name: Publish staging site

on:
  pull_request:
    branches: [ main ]

permissions:
  id-token: write # required to use OIDC authentication
  contents: read # required to checkout the code from the repo
  pull-requests: write # required to comment on the PR with the staging URL

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v6

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version-file: package.json

    - name: Configure sustainable npm
      uses: lowlydba/sustainable-npm@ed089bd92235c2af803a951fba2bd42c59fbcd73 # v2.0.0

    - name: Install
      run: npm ci

    - name: Lint
      run: npm run lint

    - name: Test
      run: npm test

  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v6

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version-file: package.json

    - name: Configure sustainable npm
      uses: lowlydba/sustainable-npm@ed089bd92235c2af803a951fba2bd42c59fbcd73 # v2.0.0

    - name: Install
      run: npm ci

    - name: Build
      run: npm run build
      env:
        BASEURL: ${{ github.event.repository.name }}/pr/${{ github.event.number }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v6
      with:
        name: build-artifact
        path: out
        if-no-files-found: error

  deploy:
    name: Deploy
    runs-on: ubuntu-slim
    needs: [test, build]
    environment:
      name: staging
      url: ${{ steps.deploy_url.outputs.url }}

    steps:
      - name: Set deploy URL
        id: deploy_url
        run: echo "url=https://staging.overturemaps.org/${{ github.event.repository.name }}/pr/${{ github.event.number }}/index.html" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: arn:aws:iam::763944545891:role/pages-staging-oidc-overturemaps
          aws-region: us-west-2

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifact
          path: build

      - name: Copy to S3
        run: |
          aws s3 sync --delete build s3://overture-managed-staging-usw2/gh-pages/${{ github.event.repository.name }}/pr/${{ github.event.number }}/

      - name: Bust the Cache
        run: aws cloudfront create-invalidation --distribution-id E1KP2IN0H2RGGT --paths "/${{ github.event.repository.name }}/pr/${{ github.event.number }}/*"

      - name: Get deploy timestamp
        id: timestamp
        run: echo "time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          message: |
            ## ğŸš€ Overture Maps explore-site branch preview deployed!

            You can review your changes at ${{ steps.deploy_url.outputs.url }}

            ---
            <sub>â™»ï¸ Last refreshed: ${{ steps.timestamp.outputs.time }}</sub>
